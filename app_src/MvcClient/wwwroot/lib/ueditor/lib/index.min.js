/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/ueditor@1.2.3/lib/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var Busboy=require("busboy"),fs=require("fs"),fse=require("fs-extra"),os=require("os"),path=require("path"),snowflake=require("node-snowflake").Snowflake,qn=require("qn");let FdfsClient=require("fdfs");var isEmpty=function(t){return 0===Object.keys(t).length&&t.constructor===Object},getFdfs=function(t){return new FdfsClient({trackers:[{host:t.upload.host,port:t.upload.port}],timeout:t.timeout||1e4,defaultExt:t.defaultExt||"png",charset:t.charset||"utf8"})},ueditor=function(t,e={},i){return function(n,o,r){respond(t,e,i)(n,o,r)}},respond=function(t,e={},i){return"function"==typeof e&&(i=e,e={}),function(n,o,r){if("config"!==n.query.action)if("listimage"===n.query.action)o.ue_list=function(e){var i=0,n=[];fs.readdir(t+e,function(t,r){if(t)throw t;var f=r.length;r.forEach(function(t){var r=t.split("."),a=r[r.length-1];if("jpg,png,gif,ico,bmp".indexOf(a.toLowerCase())>=0){var u={};u.url="/"===e?e+t:e+"/"+t,n[i]=u}++i===f&&o.json({state:"SUCCESS",list:n,start:1,total:f})})})},e.fdfs&&(o.ue_list=function(e){fs.readFile(t+e+"fdfs.list",function(t,e){var i=[];e&&e.toString().split("\n").forEach(function(t){t&&i.push(JSON.parse(t))});o.json({state:"SUCCESS",list:i,start:1,total:i.length})})}),i(n,o,r);else if("uploadimage"===n.query.action||"uploadfile"===n.query.action||"uploadvideo"===n.query.action){var f=new Busboy({headers:n.headers});f.on("file",function(f,a,u,s,l){n.ueditor={},n.ueditor.fieldname=f,n.ueditor.file=a,n.ueditor.filename=u,n.ueditor.encoding=s,n.ueditor.mimetype=l,o.ue_up=function(i){var r=path.join(os.tmpdir(),path.basename(u)),f=snowflake.nextId()+path.extname(r),s=path.join(t,i,f);if(e.qn)return qn.create(e.qn).upload(a,{key:"ueditor/images/"+f},function(t,e){if(t)throw t;o.json({url:e.url,title:n.body.pictitle,original:u,state:"SUCCESS"})}),!1;if(e.fdfs){var l=getFdfs(e.fdfs),c=[];a.on("data",function(t){c.push(t)}),a.on("end",function(){var r=Buffer.concat(c);l.upload(r).then(function(r){var f={url:"http://"+e.fdfs.download.host+"/"+r,title:n.body&&n.body.pictitle||u,original:u,state:"SUCCESS"};fse.createFile(path.join(t,i,"fdfs.list"),function(e){if(e)throw e;fs.open(path.join(t,i,"fdfs.list"),"a",function(t,e){if(t)throw t;fs.write(e,"\n"+JSON.stringify(f),function(t){if(t)throw t})})}),o.json(f)}).catch(function(t){if(t)throw t})})}if(!e||isEmpty(e)||e.local){var d=fs.createWriteStream(r);a.pipe(d),d.on("close",function(){fse.move(r,s,function(t){if(t)throw t;o.json({url:path.join(i,f).replace(/\\/g,"/"),title:n.body.pictitle,original:u,state:"SUCCESS"})})})}},i(n,o,r)}),n.pipe(f)}else i(n,o,r);else i(n,o,r)}};module.exports=ueditor;
//# sourceMappingURL=/sm/f593dce79a998d0264ba26e770836e568e3f73bd6c82e9cf42b1442c4caeb562.map